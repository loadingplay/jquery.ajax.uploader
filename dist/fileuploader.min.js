"use strict";var FileUploader=function(a,b){this.$obj=$(a),this.options=b,this.waterfall=new Waterfall,this.model=[],this.view=new FileUploaderView(this),this.view.init(),this.preloadImages(b.images)};FileUploader.prototype.addImagePreloading=function(a,b){var c=this,d=null,e=new Blob;if(e.name=b.name,d=c.addImage(e,!0),d.value=b.value,d.url=b.src,d.percentComplete=100,"local"==c.options.thumbnail_origin)c.view.showThumb(a,d.value);else{var f=d.value;""!==c.options.thumbnail&&("object"!=typeof d.value&&(d.value=$.parseJSON(d.value)),f=d.value[c.options.thumbnail]),c.view.showThumb(a,f)}c.view.updateurl()},FileUploader.prototype.preloadImages=function(a){for(var b=0;b<a.length;b++){var c=a[b];this.addImagePreloading(b,c)}},FileUploader.prototype.addImage=function(a,b){var c=this;if(this.isImage(a.name)){var d=new LPImage({uploaded:b,file:a,uploadurl:this.options.uploadurl,response_type:this.options.response_type,thumbnail:this.options.thumbnail,onprogress:function(a){c.view.updateUploadProgress(c.model.indexOf(d),a)},onthumbprogress:function(a){c.view.updateThumbProgress(c.model.indexOf(d),a)},onthumbloaded:function(){c.view.imageDataLoaded(c.model.indexOf(d))},onupdateurl:function(a){c.view.updateurl(c.model.indexOf(d),a),"local"===c.options.thumbnail_origin?c.view.showThumb(c.model.indexOf(d),d.data):c.view.showThumb(c.model.indexOf(d),a)}});return this.options.multi||(this.model=[],this.waterfall.clearImages()),this.model.push(d),this.waterfall.appendImage(d),this.view.addImage(d),d}},FileUploader.prototype.isImage=function(a){return-1!=a.toLowerCase().indexOf(".jpg")||-1!=a.toLowerCase().indexOf(".png")?!0:!1},FileUploader.prototype.getImageList=function(){return this.model},FileUploader.prototype.getInput=function(){return this.$obj},FileUploader.prototype.isready=function(){for(var a=0;a<this.model.length;a++){var b=100==this.model[a].percentComplete;if(!b)return!1}return!0},FileUploader.prototype.getBaseURL=function(){return this.options.base_url},FileUploader.prototype.getImagesData=function(){for(var a=[],b=0;b<this.model.length;b++){var c=this.model[b];""!==c.value&&("string"!=typeof c.value&&(c.value=JSON.stringify(c.value)),a.push(c.value))}return a},FileUploader.prototype.deleteImage=function(a){this.model.splice(a,1)};var FileUploaderTemplates={"imgup-template":'         <div class="imgup" name="THEY HATIIN" >             <ul class="img-ulist" name="THEY SEE ME ROOOLLIN">             </ul>         </div>',"imgup-image-template":'         <li>             <div class="img-container" >                 <img src="" class="imgup-image" />                 <div class="imgup-progress" >                     <div class="imgup-progress-bar" ></div>                 </div>                 <div>                    <a class="imgup-delete-button" href="#!" >x</a>                </div>            </div>         </li>',"imgup-image-add-template":'         <li class="imgup-add-input-container" >             <input type="file" class="imgup-add-input" multiple="multiple" />         </li>',"imgup-highlight-template":'        <div class="img-container" >             <img src="{{ src }}" class="imgup-image-biger"/>         </div>    '},FileUploaderView=function(a){this.controller=a,this.main_template="",this.img_template="",this.add_img_template="",this.highlight_template="",this.$images=[],this.$main_template=void 0,this.loadTemplates(),this.thumbs_loading=[],this.is_loading=!1,this.$container=$('<div class="imageuploader-container" ></div>')};FileUploaderView.prototype.init=function(){var a=this.controller.getInput();a.css("visibility","hidden"),a.attr("type","text"),a.after(this.$container),this.render()},FileUploaderView.prototype.addInputEvent=function(a){var b=this;a.change(function(a){var c=0,d=a.target.files;for(c=0;c<d.length;c++)b.controller.addImage(d[c])})},FileUploaderView.prototype.addImage=function(a){console.log("ADDING!..."),this.clearImages();var b=this,c=$(this.img_template),d=$(".imgup-delete-button",c);$.data(d,"lpparent",c),$.data(c,"lpimage",a),this.applyPercent(c,a.thumbPercent),$(c).insertBefore($(".imgup-add-input-container",this.$main_template)),this.controller.options.highlight_spot&&c.on("click",function(){if(b.controller.isready()){var a=$(this).closest("div.imgup"),c=$(this).closest("ul.img-ulist"),d=$(this).find("img.imgup-image").attr("src");c.fadeOut("slow",function(){var b='<div class="img-container" id="img-container-big"> <img id="big-img" src="'+d+'" class="imgup-image-biger"/> </div> <button class="done">DONE</button>';a.append(b);var e=a.find("button.done");$("#big-img").on("dragstart",function(a){a.preventDefault()}),e.on("click",function(){var a=this;$("#img-container-big").fadeOut("fast"),$(this).fadeOut("fast",function(){$("#img-container-big").remove(),a.remove(),c.fadeIn("fast")})})})}}),this.initDeleteButton(d),this.$images.push(c)},FileUploaderView.prototype.initDeleteButton=function(a){var b=this,c=0,d=null;a.click(function(){b.controller.isready()&&(d=$.data(a,"lpparent"),c=b.$images.indexOf(d),b.deleteImage(c))})},FileUploaderView.prototype.deleteImage=function(a){console.log("DELETING!");var b=this.$images[a];b.remove(),this.$images.splice(a,1),this.controller.deleteImage(a),this.updateurl()},FileUploaderView.prototype.loadTemplates=function(){console.log("loading templates..."),this.main_template=FileUploaderTemplates["imgup-template"],this.img_template=FileUploaderTemplates["imgup-image-template"],this.add_img_template=FileUploaderTemplates["imgup-image-add-template"],""!==this.controller.options.templates.list_container_template&&(this.main_template=$(this.controller.options.templates.list_container_template).html()),""!==this.controller.options.templates.item_template&&(this.img_template=$(this.controller.options.templates.item_template).html()),""!==this.controller.options.templates.input_template&&(this.add_img_template=$(this.controller.options.templates.input_template).html())},FileUploaderView.prototype.clearImages=function(){this.controller.options.multi||($("li",this.$container).each(function(){$(this).hasClass("imgup-add-input-container")||$(this).remove()}),this.$images=[])},FileUploaderView.prototype.render=function(){var a=this,b=$(a.main_template),c=null;$("ul",b).append($(a.add_img_template)),a.$container.html(b),c=$(".imgup-add-input",b),c.attr("multiple",a.controller.options.multi),a.$main_template=b,a.addInputEvent(c)},FileUploaderView.prototype.updateUploadProgress=function(a,b){this.applyPercent(this.$images[a],b)},FileUploaderView.prototype.updateThumbProgress=function(a,b){this.applyPercent(this.$images[a],b)},FileUploaderView.prototype.imageDataLoaded=function(a){$(".imgup-progress-bar",this.$images[a]).css("opacity",1),$(".imgup-progress-bar",this.$images[a]).css("width",0)},FileUploaderView.prototype.showThumb=function(a,b){var c=this;this.thumbs_loading.push({img:$("img",c.$images[a]),url:b,index:a}),this.loadingThumbgs()},FileUploaderView.prototype.loadingThumbgs=function(){if(!this.is_loading){var a=this;if(this.thumbs_loading.length>0){var b=this.thumbs_loading.shift();return setTimeout(function(){var c=b.img;c.loaded=!1,c.load(function(){c.loaded||(c.load=$.noop(),c.loaded=!0,c.css("opacity","1"),a.is_loading=!1,a.loadingThumbgs())}),c.css("opacity","0"),c.attr("src",a.controller.getBaseURL()+b.url)},100),void(a.is_loading=!0)}this.is_loading=!1}},FileUploaderView.prototype.applyPercent=function(a,b){$(".imgup-progress-bar",a).css("width",b+"%")},FileUploaderView.prototype.updateurl=function(){var a=this.controller.getImagesData(),b=this.controller.getInput();b.val(a)};var LPImage=function(a){this.name="",this.size="",this.file="",this.data="",this.value="",this.url="",this.onthumbprogress=$.noop,this.onprogress=$.noop,this.onupdateurl=$.noop,this.uploadurl="/",this.onthumbloaded=$.noop,this.response_type="string",this.thumbnail="",this.uploaded=!1,void 0!==a&&(this.file=void 0!==a.file?a.file:"","object"==typeof this.file&&(this.name=void 0!==this.file.name?this.file.name:"",this.size=void 0!==this.file.size?this.file.size:""),this.onthumbprogress=void 0===a.onthumbprogress?$.noop:a.onthumbprogress,this.onprogress=void 0===a.onprogress?$.noop:a.onprogress,this.onupdateurl=void 0===a.onupdateurl?$.noop:a.onupdateurl,this.uploadurl=void 0===a.uploadurl?"/":a.uploadurl,this.onthumbloaded=void 0===a.onthumbloaded?$.noop:a.onthumbloaded,this.response_type=void 0===a.response_type?"string":a.response_type,this.thumbnail=void 0===a.thumbnail?"thumbnail":a.thumbnail,this.uploaded=void 0===a.uploaded?!1:a.uploaded),this.thumbPercent=0,this.percentComplete=0,""!==this.thumbnail&&(this.response_type="json")};LPImage.prototype.loadThumb=function(a){var b=this,c=new FileReader;c.onload=function(c){b.data=c.target.result,b.onthumbloaded(b.data),setTimeout(function(){a()},100)},c.onprogress=function(a){return a.lengthComputable?(b.thumbPercent=parseInt(a.loaded/a.total*100),void b.onthumbprogress(b.thumbPercent)):void(b.thumbPercent=100)},c.readAsDataURL(this.file)},LPImage.prototype.generateBlob=function(a,b,c){b=b||"",c=c||512;for(var d=a,e=[],f=0;f<d.length;f+=c){for(var g=d.slice(f,f+c),h=new Array(g.length),i=0;i<g.length;i++)h[i]=g.charCodeAt(i);var j=new Uint8Array(h);e.push(j)}var k=new Blob(e,{type:b});return k},LPImage.prototype.upload=function(a){var b=this,c=new FormData;c.append("name",this.name),c.append("size",this.size),c.append("data",this.generateBlob(this.data,"text/plain",512)),$.ajax({contentType:!1,processData:!1,cache:!1,url:b.uploadurl,type:"POST",xhr:function(){var a=$.ajaxSettings.xhr();return a.upload&&a.upload.addEventListener("progress",function(a){var c=a.loaded||a.position;b.percentComplete=Math.ceil(c/a.total*100),b.onprogress(b.percentComplete)},!1),a},beforeSend:function(a,b){b.data=c}}).done(function(c){b.value=c,b.onupdateurl(b.getThumbnailURI(c)),a()})},LPImage.prototype.getThumbnailURI=function(a){return"string"===this.response_type?(this.url=a,a):("object"!=typeof a?a=$.parseJSON(a):this.value=JSON.stringify(a),this.url=a[this.thumbnail],a[this.thumbnail])},function(a,b,c,d){var e="fileuploader",f={isready:function(){var b=!0;return this.each(function(){var c=a.data(this,"plugin_"+e);c.isready()||(b=!1)}),b},somefunction:function(){console.log("class: "+this.attr("class"))},loadimages:function(b){this.each(function(){try{a.data(this,"plugin_"+e).preloadImages(b)}catch(c){}})}};a.fn[e]=function(b,c){var d={base_url:"",uploadurl:"/",response_type:"string",thumbnail:"",thumbnail_origin:"local",multi:!0,highlight_spot:!1,templates:{list_container_template:"",item_template:"",input_template:""},images:[]};if(f[b])return f[b].call(this,c);c=b;var g=a.extend({},d,c);return this.each(function(){a.data(this,"plugin_"+e)||a.data(this,"plugin_"+e,new FileUploader(this,g))})}}(jQuery,window,document);var Waterfall=function(){this.images=[],this.upload_images=[],this.is_loading=!1,this.is_uploading=!1,this.uploading_counter=0};Waterfall.prototype.clearImages=function(){this.images=[]},Waterfall.prototype.appendImage=function(a){return a instanceof LPImage?a.uploaded?!1:(this.images.push(a),this.loadThumbs(),!0):!1},Waterfall.prototype.loadThumbs=function(){if(!this.is_loading){var a=this;if(this.images.length>0){var b=this.images.shift();return void(b.uploaded||(this.is_loading=!0,b.loadThumb(function(){a.is_loading=!1,a.loadThumbs(),a.upload_images.push(b),a.uploadImages()})))}this.is_loading=!1}},Waterfall.prototype.uploadImages=function(){if(!(this.is_uploading&&this.uploading_counter>=3)){var a=this;if(this.upload_images.length>0){var b=this.upload_images.shift();return this.is_uploading=!0,this.uploading_counter+=1,void b.upload(function(){a.uploading_counter-=1,a.is_uploading=!1,a.uploadImages()})}this.uploading_counter-=1,this.is_uploading=!1}};